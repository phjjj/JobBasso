#!/usr/bin/env sh

echo "🔍 이슈 번호 검사"

BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
echo "🌿 현재 브랜치: $BRANCH_NAME"

# 브랜치명은 feature/123 또는 feature/123-xxx 등과 같은 형식이어야 함
branch_regex='^(feature|bugfix|hotfix|refactor|docs|test|chore|perf)/[0-9]+(\-.+)?'

if ! echo "$BRANCH_NAME" | grep -qE "$branch_regex"; then
  echo "❌ 잘못된 브랜치 명입니다." >&2
  echo "👉 올바른 브랜치 명은 feature/이슈번호-설명 와 같은 형식이어야 합니다." >&2
  echo "feature|bugfix|hotfix|refactor|docs|test|chore|perf 중 하나여야 합니다." >&2
  exit 1
fi

# 이슈 번호 추출
ISSUE_ID=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+')
echo "🔢 추출된 이슈 번호: $ISSUE_ID"

if [ -z "$ISSUE_ID" ]; then
  echo "❌ 브랜치명에서 이슈 번호를 찾을 수 없습니다." >&2
  echo "👉 브랜치명에 이슈 번호가 포함되어 있어야 합니다." >&2
  exit 1
fi

# 이미 이슈 번호가 포함되어 있는지 확인
if grep -q "\[#${ISSUE_ID}\]" "$1"; then
  echo "ℹ️  이미 이슈 번호 [#$ISSUE_ID]가 포함되어 있습니다."
  echo "   커밋 메시지: $(head -1 "$1")"
  echo "✅ 이슈 번호 추가 과정을 건너뜁니다."
  exit 0
fi

# 다른 이슈 번호가 포함되어 있는지 확인
if grep -q "\[#[0-9]+\]" "$1"; then
  echo "⚠️  다른 이슈 번호가 이미 포함되어 있습니다."
  echo "   현재 메시지: $(head -1 "$1")"
  echo "   브랜치 이슈 번호: #$ISSUE_ID"
  echo "   기존 이슈 번호를 유지합니다."
  exit 0
fi

# 이슈 번호 추가
echo "�� 이슈 번호 [#$ISSUE_ID] 추가"
sed -i.bak "1s/^/[#${ISSUE_ID}] /" "$1"
echo "✅ 이슈 번호 추가 완료"
echo "   수정된 메시지: $(head -1 "$1")"